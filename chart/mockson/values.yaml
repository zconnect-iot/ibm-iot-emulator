---
STUPID_NO_TLS: true
ingress:
  host_backend: mqtt.zoetrope.local
  paths:
    - /mqtt

service:
  name: broker

deployment:
  replicas: 1

  broker:
    image: erlio/docker-vernemq:1.2.0

    resources:
      limits:
        cpu: 100m
        memory: 400Mi
      requests:
        cpu: 25m
        memory: 400Mi

    # FIXME
    # Moved to configmap - requires knowing the deployment name
    # config: |
    #   listener.ws.default = 127.0.0.1:8080

    #   # Turn off password auth
    #   plugins.vmq_passwd = off
    #   plugins.vmq_acl = off

    #   # Enable webhooks
    #   plugins.vmq_webhooks = on

    #   # Use mongodb for auth
    #   vmq_diversity.auth_mongodb.enabled = on
    #   vmq_diversity.mongodb.host = solitary-dingo-mongodb
    #   vmq_diversity.mongodb.port = 27017
    #   vmq_diversity.mongodb.database = vernemq

    #   log.console.level = debug

    #   # the hooks
    #   vmq_webhooks.on_register.hook = on_register
    #   vmq_webhooks.on_client_gone.hook = on_client_gone
    #   vmq_webhooks.on_client_offline.hook = on_client_offline

    #   vmq_webhooks.on_register.endpoint = http://solitary-dingo-webhooks:5000/on_register
    #   vmq_webhooks.on_client_offline.endpoint = http://solitary-dingo-webhooks:5000/on_client_offline
    #   vmq_webhooks.on_client_gone.endpoint = http://solitary-dingo-webhooks:5000/on_client_gone

  webhooks:
    image: eu.gcr.io/overlock-192311/mockson-webhooks:0.2.0

    resources:
      limits:
        cpu: 100m
        memory: 200Mi
      requests:
        cpu: 25m
        memory: 100Mi

  seed:
    # THIS SHOULD ONLY BE ENABLED IF USING 1 REPLICA!!
    enabled: false
    image: eu.gcr.io/overlock-192311/mockson-seed:0.2.0


# ConfigMap - each value is set as an environment variable in every container
global_config:
  name: exampleconfig
  create: true
  data:
    GET_HOSTS_FROM: dns

    # used by erland pod only
    WAIT_FOR_ERLANG: 600

    # Used by broker pod only
    MQTT_HOST: vernemq
    MQTT_PORT: 8080
    HOOK_PORT: 5000


mongodb:
  persistence:
    enabled: false

  resources:
    limits:
      cpu: 100m
      memory: 500Mi
    requests:
      cpu: 100m
      memory: 256Mi
